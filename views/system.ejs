<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>System - Communication LTD</title>
  <link rel="stylesheet" href="/css/style.css" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, private" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="referrer" content="no-referrer" />

  <!-- נועל Back, רץ מוקדם מאוד -->
  <script>
    (function () {
      "use strict";

      // אם הגענו לכאן מעמוד שאינו /system (למשל change-password),
      // נחליף את הרשומה הקודמת כדי שלא יהיה לאן "לחזור".
      try {
        if (document.referrer && !/\/system(\?|$)/.test(new URL(document.referrer).pathname)) {
          history.replaceState(null, "", location.href);
        }
      } catch (_) {
        history.replaceState(null, "", location.href);
      }

      // אל תצברי querystring בהיסטוריה
      if (history.replaceState) history.replaceState(null, "", location.pathname);

      // כדי לנטרל BFCache (בחלק מהדפדפנים) ולהימנע משחזור דפים קודמים
      addEventListener("unload", function(){});

      // דוחפים שתי רשומות, וכל Back מחזיר אותנו מיד ל-/system
      history.pushState({lock:true},"",location.href);
      history.pushState({lock:true},"",location.href);

      addEventListener("popstate", function () {
        // קפיצה קדימה ואז החלפה ל-/system כדי לוודא שלא יצאנו מהעמוד
        history.go(1);
        location.replace("/system");
      });
    })();
  </script>
</head>
<body class="system-page">
  <header>
    <h1>System Page</h1>
    <nav>
      <a href="/change-password" class="replace-link" onclick="event.preventDefault();location.replace(this.href);">Change Password</a> |
      <a href="/logout" class="replace-link" onclick="event.preventDefault();location.replace(this.href);">Logout</a>
    </nav>
  </header>

  <main class="container">
    <p>Welcome, <%= username %>!</p>

    <% if (error) { %><div class="error"><%= error %></div><% } %>
    <% if (success) { %><div class="success"><%= success %></div><% } %>

    <section>
      <h2>Add Customer</h2>
      <form action="/system-page" method="post" autocomplete="off">
        <label>Name:  <input type="text" name="newcustomer" required /></label><br />
        <label>Email: <input type="email" name="email" /></label><br />
        <label>Phone: <input type="text" name="phone" /></label><br />
        <button type="submit">Add</button>
      </form>
    </section>

    <section>
      <h2>Customers</h2>
      <% if (customers && customers.length > 0) { %>
        <ul>
          <% customers.forEach(c => { %>
            <% if (mode === "vuln") { %>
              <li><%- c.name %> | <%- c.email || "" %> | <%- c.phone || "" %></li>
            <% } else { %>
              <li><%= c.name %> | <%= c.email || "" %> | <%= c.phone || "" %></li>
            <% } %>
          <% }) %>
        </ul>
      <% } else { %>
        <p>No customers yet.</p>
      <% } %>
    </section>
  </main>

  <script>
    // ביטוח כפול: כל קישור עם replace-link ינווט ב-replace (גם אם הסקריפט העליון עוד לא נטען)
    document.querySelectorAll(".replace-link").forEach(function (a) {
      a.addEventListener("click", function (ev) {
        ev.preventDefault();
        location.replace(a.href);
      });
    });
  </script>
</body>
</html>






